name: Mirror to woololies-mirrored

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/mirror.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  mirror:
    if: github.repository != 'ourfirstfluke-creator/woololies-mirrored'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # actions/checkout sets an auth extraheader for github.com (GITHUB_TOKEN).
          # That header can override the credentials embedded in the mirror URL and cause 404s.
          git config --local --unset-all http.https://github.com/.extraheader || true

      - name: Debug token length (preflight)
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          python -c "import os; t=os.environ.get('MIRROR_TOKEN',''); print('len:', len(t), 'strip_len:', len(t.strip()), 'has_newline:', ('\\n' in t))"

      - name: Debug auth endpoints (preflight)
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          python - <<'PY'
          import base64
          import os
          import urllib.error
          import urllib.request

          t = os.environ.get("MIRROR_TOKEN", "")

          def fetch(url: str, headers: dict):
              req = urllib.request.Request(url, headers=headers)
              try:
                  with urllib.request.urlopen(req, timeout=20) as resp:
                      return resp.status, dict(resp.headers)
              except urllib.error.HTTPError as e:
                  return e.code, dict(e.headers)
              except Exception as e:
                  return None, {"error": str(e)}

          api_headers = {
              "Authorization": f"token {t}",
              "Accept": "application/vnd.github+json",
          }

          code_u, h_u = fetch("https://api.github.com/user", api_headers)
          print(f"api_user_http:{code_u}")
          scopes = h_u.get("X-OAuth-Scopes") or h_u.get("x-oauth-scopes") or ""
          print(f"api_user_scopes:{scopes}")

          code_r, _h_r = fetch(
              "https://api.github.com/repos/ourfirstfluke-creator/woololies-mirrored",
              api_headers,
          )
          print(f"api_repo_http:{code_r}")

          auth = base64.b64encode(f"x-access-token:{t}".encode()).decode()
          code_g, _h_g = fetch(
              "https://github.com/ourfirstfluke-creator/woololies-mirrored.git/info/refs?service=git-upload-pack",
              {"Authorization": f"Basic {auth}", "User-Agent": "git/2.0"},
          )
          print(f"git_info_refs_http:{code_g}")
          PY

      - name: Add mirror remote (preflight)
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          git remote remove mirror || true
          git remote add mirror "https://x-access-token:${MIRROR_TOKEN}@github.com/ourfirstfluke-creator/woololies-mirrored.git"
          GIT_CURL_VERBOSE=1 git ls-remote mirror

      - name: Push to mirror
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          git push --force --prune mirror main
